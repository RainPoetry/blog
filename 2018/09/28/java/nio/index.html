<!DOCTYPE html>












  


<html class="theme-next mist use-motion" lang="zh-CN">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2"/>
<meta name="theme-color" content="#222">






  
  
    
      
    
    
      
    
  <script src="//cdn.bootcss.com/pace/1.0.2/pace.min.js"></script>
  <link href="//cdn.bootcss.com/pace/1.0.2/themes/blue/pace-theme-flash.min.css" rel="stylesheet">







<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
    
  
  <link href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.2.5/jquery.fancybox.min.css" rel="stylesheet" type="text/css" />







  

<link href="https://cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.css" rel="stylesheet" type="text/css" />

<link href="/blog/css/main.css?v=6.4.0" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/blog/images/moon.ico?v=6.4.0">


  <link rel="icon" type="image/png" sizes="32x32" href="/blog/images/moon.ico?v=6.4.0">


  <link rel="icon" type="image/png" sizes="16x16" href="/blog/images/moon.ico?v=6.4.0">


  <link rel="mask-icon" href="/blog/images/moon.ico?v=6.4.0" color="#222">









<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/blog/',
    scheme: 'Mist',
    version: '6.4.0',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta name="description" content="掌握 java nio 的基本使用">
<meta name="keywords" content="java,nio">
<meta property="og:type" content="article">
<meta property="og:title" content="Java nio 浅析">
<meta property="og:url" content="https://rainpoetry.github.io/blog/2018/09/28/java/nio/index.html">
<meta property="og:site_name" content="cc 的个人博客">
<meta property="og:description" content="掌握 java nio 的基本使用">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="https://rainpoetry.github.io/blog/2018/09/28/java/nio/reactor.png">
<meta property="og:image" content="https://rainpoetry.github.io/blog/2018/09/28/java/nio/threadpool.png">
<meta property="og:image" content="https://rainpoetry.github.io/blog/2018/09/28/java/nio/muilt_reactors.png">
<meta property="og:updated_time" content="2018-09-29T00:56:07.820Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Java nio 浅析">
<meta name="twitter:description" content="掌握 java nio 的基本使用">
<meta name="twitter:image" content="https://rainpoetry.github.io/blog/2018/09/28/java/nio/reactor.png">






  <link rel="canonical" href="https://rainpoetry.github.io/blog/2018/09/28/java/nio/"/>



<script type="text/javascript" id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>Java nio 浅析 | cc 的个人博客</title>
  









  <noscript>
  <style type="text/css">
    .use-motion .motion-element,
    .use-motion .brand,
    .use-motion .menu-item,
    .sidebar-inner,
    .use-motion .post-block,
    .use-motion .pagination,
    .use-motion .comments,
    .use-motion .post-header,
    .use-motion .post-body,
    .use-motion .collection-title { opacity: initial; }

    .use-motion .logo,
    .use-motion .site-title,
    .use-motion .site-subtitle {
      opacity: initial;
      top: initial;
    }

    .use-motion {
      .logo-line-before i { left: initial; }
      .logo-line-after i { right: initial; }
    }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/blog/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">cc 的个人博客</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="切换导航栏">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">
    <a href="/blog/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-home"></i> <br />首页</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-tags">
    <a href="/blog/tags/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />标签</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-categories">
    <a href="/blog/categories/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-th"></i> <br />分类</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">
    <a href="/blog/archives/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />归档</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-java">
    <a href="/blog/tags/java/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-leaf"></i> <br />java</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-kafka">
    <a href="/blog/tags/kafka/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-paper-plane"></i> <br />kafka</a>
  </li>

      
      
    </ul>
  

  
    

  

  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://rainpoetry.github.io/blog/blog/2018/09/28/java/nio/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="RainPoetry">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/blog/upload/head.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="cc 的个人博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">Java nio 浅析
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2018-09-28 21:39:04" itemprop="dateCreated datePublished" datetime="2018-09-28T21:39:04+08:00">2018-09-28</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2018-09-29 08:56:07" itemprop="dateModified" datetime="2018-09-29T08:56:07+08:00">2018-09-29</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/blog/categories/java/" itemprop="url" rel="index"><span itemprop="name">java</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          
             <span id="/blog/2018/09/28/java/nio/" class="leancloud_visitors" data-flag-title="Java nio 浅析">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数：</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          
              <div class="post-description">掌握 java nio 的基本使用</div>
          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>在 Java IO 网络编程中，传统的 BIO 开发简单，但只适用于并发量少的场合，因为 BIO 要么对每一个请求开启一个线程处理导致服务器资源不足而宕机，要么采用线程池的方式接收请求，限制并发量，导致高延迟。nio 的出现就是为了解决高并发和大量连接的场景。</p>
<h1 id="nio-核心组件"><a href="#nio-核心组件" class="headerlink" title="nio 核心组件"></a>nio 核心组件</h1><div class="note primary no-icon"><p>channel:<br>    &nbsp;&nbsp;&nbsp;&nbsp;网络IO通道，类似于java io 流，数据的输入和输出是通过这个通道来进行的<br>buffer：<br>    &nbsp;&nbsp;&nbsp;&nbsp;channel 中的数据不能直接获取，必须通过 buffer 进行转换后得到<br>Selector:<br>    &nbsp;&nbsp;&nbsp;&nbsp;监听 channel 并处理监听事件</p></div>
<h1 id="Channel"><a href="#Channel" class="headerlink" title="Channel"></a>Channel</h1><h2 id="channel-类别"><a href="#channel-类别" class="headerlink" title="channel 类别"></a>channel 类别</h2><div class="note primary no-icon"><p>FileChannel:   &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  &nbsp;&nbsp;&nbsp;&nbsp;  &nbsp;&nbsp;&nbsp;&nbsp; 从文件中读写数据<br>DatagramChannel:   &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     通过 UDP 读写网络中的数据<br>SocketChannel:   &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  &nbsp;&nbsp;&nbsp;&nbsp; 通过 tcp 读写网络中的数据<br>ServerSocketChannel: &nbsp;&nbsp;监听新进来的 TCP 连接</p></div>
<h2 id="FileChannel"><a href="#FileChannel" class="headerlink" title="FileChannel"></a>FileChannel</h2><div class="note info"><p>transferFrom()：<br>&nbsp;&nbsp;&nbsp;&nbsp;将一个channel 中的数据传输到 FIleChannel 中<br>transferTo()：<br>&nbsp;&nbsp;&nbsp;&nbsp;将 FileChannel 中的数据传输到 其他的 Channel 中</p></div>
<h1 id="Buffer"><a href="#Buffer" class="headerlink" title="Buffer"></a>Buffer</h1><h2 id="buffer-类别"><a href="#buffer-类别" class="headerlink" title="buffer 类别"></a>buffer 类别</h2><div class="note info"><p>ByteBuffer<br>CharBuffer<br>DoubleBuffer<br>FloatBuffer<br>IntBuffer<br>LongBuffer<br>ShortBuffer</p></div>
<h2 id="buffer-重要属性"><a href="#buffer-重要属性" class="headerlink" title="buffer 重要属性"></a>buffer 重要属性</h2><p>根据当前 buffer 是写入数据还是读取数据，将 buffer 分为 读模式和写模式<br><div class="note primary"><p>capacity：<br>    &nbsp;&nbsp;&nbsp;&nbsp;是一个内存块，缓冲区的固定大小<br>position：<br>    &nbsp;&nbsp;&nbsp;&nbsp;position 表示当前读数据或者写数据的位置，flip() 和 clear() 会使 position=0，<br>limit：<br>    &nbsp;&nbsp;&nbsp;&nbsp;写模式下，limit 表示能写入多少数据，最大为缓冲区的大小，因此，limit = capacity<br>    &nbsp;&nbsp;&nbsp;&nbsp;读模式下，limit 表示最大能读取多少数据，最大为写模式下 position 的最终位置</p></div></p>
<h2 id="buffer-的使用方式"><a href="#buffer-的使用方式" class="headerlink" title="buffer 的使用方式"></a>buffer 的使用方式</h2><h3 id="创建-buffer"><a href="#创建-buffer" class="headerlink" title="创建 buffer"></a>创建 buffer</h3><figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 方法一： 采用 allocate 分配指定大小的缓冲区</span></span><br><span class="line"> IntBuffer buf = IntBuffer.allocate(<span class="number">16</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 方法二： 在数组的基础上创建 buffer</span></span><br><span class="line">int[] arrays= new int[]&#123;<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>&#125;;</span><br><span class="line">IntBuffer buf2 =  IntBuffer.wrap(arrays);</span><br></pre></td></tr></table></figure>
<h3 id="写入数据到-buffer"><a href="#写入数据到-buffer" class="headerlink" title="写入数据到 buffer"></a>写入数据到 buffer</h3><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 方法一： 通过Buffer的put()写到Buffer里</span></span><br><span class="line">buf.<span class="built_in">put</span>(<span class="number">123</span>);</span><br><span class="line">    </span><br><span class="line"><span class="comment">// 方法二： 通过 channel 向 buffer 中写入数据</span></span><br><span class="line">SocketChannel channel;</span><br><span class="line"><span class="keyword">int</span> bytesRead = channel.<span class="built_in">read</span>(buf); <span class="comment">// 将 channel 中的数据写入到 buffer</span></span><br></pre></td></tr></table></figure>
<h3 id="获取-buffer-中的数据"><a href="#获取-buffer-中的数据" class="headerlink" title="获取 buffer 中的数据"></a>获取 buffer 中的数据</h3><figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">// 方法一： 通过 <span class="keyword">Buffer </span>的 <span class="meta">get</span>() 直接获取数据</span><br><span class="line"><span class="symbol">Object</span> <span class="meta">data</span> = <span class="keyword">buf.get()</span></span><br><span class="line"><span class="keyword"></span></span><br><span class="line"><span class="keyword">// </span>方法二： 通过 channnel将 <span class="keyword">buffer </span>中的数据写入到 channel</span><br><span class="line"><span class="symbol">channel.write</span>(<span class="keyword">buf)</span></span><br></pre></td></tr></table></figure>
<h2 id="buffer-重要方法"><a href="#buffer-重要方法" class="headerlink" title="buffer 重要方法"></a>buffer 重要方法</h2><div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:left">方法名称</th>
<th style="text-align:left">作用</th>
<th style="text-align:left">capacity、position、limit</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left"> flip()</td>
<td style="text-align:left">为缓冲区的读 <br>（将缓冲区从写模式切换为读模式）</td>
<td style="text-align:left">position：0 <br> limit = 写入数据时的position<br> capacity = 缓冲区大小</td>
</tr>
<tr>
<td style="text-align:left"> clear()</td>
<td style="text-align:left">缓冲区清空，为缓冲区的写做好准备 <br> （将缓冲区从读模式切换到写模式）</td>
<td style="text-align:left">position：0 <br> limit = capacity = 缓冲区大小</td>
</tr>
<tr>
<td style="text-align:left"> compact()</td>
<td style="text-align:left">清除已读取的数据<br>未读取的数据拷贝到 buffer 的起始处</td>
<td style="text-align:left">position：未读取数据的末尾position  <br> limit = capacity = 缓冲区大小</td>
</tr>
<tr>
<td style="text-align:left"> rewind()</td>
<td style="text-align:left">重新读取数据</td>
<td style="text-align:left">position：0 <br> limit 保持不变 <br> capacity =  缓冲区大小</td>
</tr>
<tr>
<td style="text-align:left"> mark() &amp; reset()</td>
<td style="text-align:left">mark() 标记此时 position <br>reset() 使 buffer 的 position 恢复到被标记的位置</td>
<td style="text-align:left">limit 保持不变 <br> capacity =  缓冲区大小</td>
</tr>
</tbody>
</table>
</div>
<h1 id="Selector"><a href="#Selector" class="headerlink" title="Selector"></a>Selector</h1><h2 id="selector-使用"><a href="#selector-使用" class="headerlink" title="selector 使用"></a>selector 使用</h2><h3 id="创建-selector"><a href="#创建-selector" class="headerlink" title="创建 selector"></a>创建 selector</h3><figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Selector </span><span class="keyword">seletor </span>= <span class="keyword">Selector.open()</span></span><br></pre></td></tr></table></figure>
<h3 id="向-selector-注册-channel"><a href="#向-selector-注册-channel" class="headerlink" title="向 selector 注册 channel"></a>向 selector 注册 channel</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// channel 必须是非阻塞的</span></span><br><span class="line">channel.configureBlocking(<span class="literal">false</span>);</span><br><span class="line"><span class="comment">// 将 channel 注册到 Selector 上, 并监听该 channel 的 OP_ACCEPT 事件</span></span><br><span class="line">SelectionKey key = channel.<span class="keyword">register</span>(selector,Selectionkey.OP_ACCEPT);</span><br></pre></td></tr></table></figure>
<h3 id="监听事件"><a href="#监听事件" class="headerlink" title="监听事件"></a>监听事件</h3><div class="note primary"><p>SelectionKey.OP_CONNECT<br>SelectionKey.OP_ACCEPT<br>SelectionKey.OP_READ<br>SelectionKey.OP_WRITE</p></div>
<p>监听多个事件： channel.register(selector,Selectionkey.OP_READ | SelectionKey.OP_WRITE);</p>
<h2 id="Selector-重要函数"><a href="#Selector-重要函数" class="headerlink" title="Selector 重要函数"></a>Selector 重要函数</h2><div class="note primary"><p>select()</p></div>
<p>作用： 返回上一次 select() 调用后进入就绪状态的通道<br>select()： 是一个阻塞操作，阻塞到至少有一个通道在你注册的事件上就绪了<br>select(long timeout)： 和select()一样，除了最长会阻塞timeout毫秒(参数)。<br>selectNow() 非阻塞</p>
<div class="note primary"><p>wakeup()</p></div>
<p>作用：<br>唤醒调用 select() 后阻塞的线程<br>如果当前Selector没有阻塞在select方法上，那么本次 wakeup调用会在下一次select阻塞的时候生效<br>两次成功的select之间多次调用wakeup等价于一次调用</p>
<h1 id="Reactor-模式"><a href="#Reactor-模式" class="headerlink" title="Reactor 模式"></a>Reactor 模式</h1><h2 id="单线程处理所有请求"><a href="#单线程处理所有请求" class="headerlink" title="单线程处理所有请求"></a>单线程处理所有请求</h2><p>channel 的所有监听事件都在一个线程中轮询进行<br><img src="/blog/2018/09/28/java/nio/reactor.png" title="单线程模式"><br><figure class="highlight processing"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> *  一个 Reactor 监听所有的 channel 请求</span></span><br><span class="line"><span class="comment"> *  所有的读写操作都在主线程中进行</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> class Server &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger <span class="built_in">log</span> = LoggerFactory.getLogger(Server.class);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> main(<span class="keyword">String</span>[] args) <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="comment">// 创建一个 Selector</span></span><br><span class="line">        Selector s = Selector.<span class="built_in">open</span>();</span><br><span class="line">        <span class="comment">// 创建一个 serverSocketChannel</span></span><br><span class="line">        ServerSocketChannel serverSocketChannel = ServerSocketChannel.<span class="built_in">open</span>();</span><br><span class="line">        serverSocketChannel.configureBlocking(<span class="keyword">false</span>);</span><br><span class="line">        serverSocketChannel.bind(<span class="keyword">new</span> InetSocketAddress(<span class="number">1234</span>));</span><br><span class="line">        <span class="comment">// 将 channel 注册到 Selector 上, 并监听该 channel 的 OP_ACCEPT 事件</span></span><br><span class="line">        serverSocketChannel.register(s, SelectionKey.OP_ACCEPT );</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 阻塞线程，直到有一个channel处于就绪状态</span></span><br><span class="line">        <span class="keyword">while</span>(s.select()&gt;<span class="number">0</span>)&#123;</span><br><span class="line">            <span class="comment">// 获取就绪的键集</span></span><br><span class="line">            Set&lt;SelectionKey&gt; keys = s.selectedKeys();</span><br><span class="line">            Iterator&lt;SelectionKey&gt; iterator = keys.iterator();</span><br><span class="line">            <span class="keyword">while</span>(iterator.hasNext())&#123;</span><br><span class="line">                SelectionKey <span class="built_in">key</span> = iterator.next();</span><br><span class="line">                <span class="comment">// Selector 不会删除掉 SelectionKey，需要手动删除</span></span><br><span class="line">                iterator.remove();</span><br><span class="line">                <span class="keyword">if</span>(<span class="built_in">key</span>.isAcceptable())&#123;</span><br><span class="line">                    <span class="comment">// 当有新的 tcp 连接请求到来时，访问 selector 上绑定的 channel 通道，来处理该事件</span></span><br><span class="line">                    <span class="comment">// 对应上面注册的 ServerSocketChannel</span></span><br><span class="line">                    ServerSocketChannel acceptChannel = (ServerSocketChannel) <span class="built_in">key</span>.channel();</span><br><span class="line">                    <span class="comment">// 监听新进来的TCP连接的通道</span></span><br><span class="line">                    SocketChannel channel = acceptChannel.accept();</span><br><span class="line">                    channel.configureBlocking(<span class="keyword">false</span>);</span><br><span class="line">                    <span class="built_in">log</span>.info(<span class="string">"accept request from &#123;&#125;"</span>,channel.getRemoteAddress());</span><br><span class="line">                    channel.register(s,SelectionKey.OP_READ);</span><br><span class="line">                &#125;<span class="keyword">else</span> <span class="keyword">if</span>(<span class="built_in">key</span>.isReadable())&#123;</span><br><span class="line">                    <span class="comment">// 对应 key.isAcceptable() 中注册的 SocketChannel</span></span><br><span class="line">                    SocketChannel socketChannel = (SocketChannel) <span class="built_in">key</span>.channel();</span><br><span class="line">                    ByteBuffer buf = ByteBuffer.allocate(<span class="number">1024</span>);</span><br><span class="line">                    <span class="comment">// 将channel 中的数据写入 ByteBuffer</span></span><br><span class="line">                    <span class="built_in">int</span> count = socketChannel.read(buf);</span><br><span class="line">                    <span class="comment">// 如果客户端被关闭</span></span><br><span class="line">                    <span class="keyword">if</span>(count&lt;=<span class="number">0</span>)&#123;</span><br><span class="line">                        socketChannel.close();</span><br><span class="line">                        <span class="built_in">key</span>.cancel(); <span class="comment">// 取消注册该channel</span></span><br><span class="line">                        <span class="built_in">log</span>.info(<span class="string">"Received invalide data, close the connection"</span>);</span><br><span class="line">                        <span class="keyword">continue</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">// 将 Buffer 重写模式转换位读模式</span></span><br><span class="line">                    buf.flip();</span><br><span class="line">                    <span class="built_in">byte</span>[] bytes = <span class="keyword">new</span> <span class="built_in">byte</span>[buf.limit()];</span><br><span class="line">                    <span class="comment">// 将 Buffer 数据写入 byte[]</span></span><br><span class="line">                    buf.<span class="built_in">get</span>(bytes);</span><br><span class="line">                    <span class="built_in">log</span>.info(<span class="string">"receive Message : "</span> + <span class="keyword">new</span> <span class="keyword">String</span>(bytes,<span class="string">"utf-8"</span>));</span><br><span class="line">                &#125;</span><br><span class="line">                keys.remove(<span class="built_in">key</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="多线程处理"><a href="#多线程处理" class="headerlink" title="多线程处理"></a>多线程处理</h2><p>将 selector 监听到的读操作以任务的形式提交到线程池来处理，有效利用多核系统的 cpu 资源<br><img src="/blog/2018/09/28/java/nio/threadpool.png" title="线程池模式"></p>
<figure class="highlight processing"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> *  一个 Reactor 监听所有的 channel 请求</span></span><br><span class="line"><span class="comment"> *  采用线程池的方式，开启多个线程同时处理读写操作</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> class Server &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger <span class="built_in">log</span> = LoggerFactory.getLogger(Server.class);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span>  <span class="built_in">int</span> port = <span class="number">1234</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> main(<span class="keyword">String</span>[] args) <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="comment">// 创建一个 Selector</span></span><br><span class="line">        Selector s = Selector.<span class="built_in">open</span>();</span><br><span class="line">        <span class="comment">// 创建 ServerSocketChannel</span></span><br><span class="line">        ServerSocketChannel serverSocketChannel = ServerSocketChannel.<span class="built_in">open</span>();</span><br><span class="line">        serverSocketChannel.configureBlocking(<span class="keyword">false</span>);</span><br><span class="line">        serverSocketChannel.bind(<span class="keyword">new</span> InetSocketAddress(port));</span><br><span class="line">        <span class="comment">// 将 channel 注册到 Selector 上, 并监听该 channel 的 OP_ACCEPT 事件</span></span><br><span class="line">        serverSocketChannel.register(s, SelectionKey.OP_ACCEPT);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span>(<span class="keyword">true</span>)&#123;</span><br><span class="line">            <span class="comment">// 不会阻塞当前的线程，返回处于就绪状态的 channel 个数</span></span><br><span class="line">            <span class="keyword">if</span>(s.selectNow()&lt;<span class="number">0</span>)&#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 获取就绪的键集</span></span><br><span class="line">            Set&lt;SelectionKey&gt; keys = s.selectedKeys();</span><br><span class="line">            Iterator&lt;SelectionKey&gt; iterator = keys.iterator();</span><br><span class="line">            <span class="keyword">while</span>(iterator.hasNext())&#123;</span><br><span class="line">                SelectionKey <span class="built_in">key</span>  = iterator.next();</span><br><span class="line">                <span class="comment">// Selector 不会删除掉 SelectionKey，需要手动删除</span></span><br><span class="line">                iterator.remove();</span><br><span class="line">                <span class="keyword">if</span>(<span class="built_in">key</span>.isAcceptable())&#123;</span><br><span class="line">                    ServerSocketChannel acceptChannel = (ServerSocketChannel)<span class="built_in">key</span>.channel();</span><br><span class="line">                    SocketChannel socketChannel = acceptChannel.accept();</span><br><span class="line">                    socketChannel.configureBlocking(<span class="keyword">false</span>);</span><br><span class="line">                    <span class="built_in">log</span>.info(<span class="string">"Accept request from &#123;&#125;"</span>, socketChannel.getRemoteAddress());</span><br><span class="line">                    SelectionKey readKey = socketChannel.register(s,SelectionKey.OP_READ);</span><br><span class="line">                    <span class="comment">// 将 Processor 对象绑定在 SelectionKey 上</span></span><br><span class="line">                    readKey.attach(<span class="keyword">new</span> Processor());</span><br><span class="line">                &#125;<span class="keyword">else</span> <span class="keyword">if</span>(<span class="built_in">key</span>.isReadable())&#123;</span><br><span class="line">                    <span class="comment">// 获取 SelectionKey 的绑定信息</span></span><br><span class="line">                    Processor p = (Processor) <span class="built_in">key</span>.attachment();</span><br><span class="line">                    <span class="comment">// 提交 任务到 线程池进行处理</span></span><br><span class="line">                    p.process(<span class="built_in">key</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight livescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">public <span class="class"><span class="keyword">class</span> <span class="title">Processor</span> &#123;</span></span><br><span class="line"></span><br><span class="line">    private static final Logger LOGGER = LoggerFactory.getLogger(Processor.class);</span><br><span class="line">    <span class="regexp">// 定义一个线程池</span></span><br><span class="line"><span class="regexp">    private static final ExecutorService service = Executors.newFixedThreadPool(16);</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">    //</span> 提交任务到线程池进行处理</span><br><span class="line">    public <span class="literal">void</span> process(SelectionKey selectionKey) &#123;</span><br><span class="line">        service.submit<span class="function"><span class="params">(() -&gt; &#123;</span></span></span><br><span class="line"><span class="function"><span class="params">            ByteBuffer buffer = ByteBuffer.allocate(<span class="number">1024</span>);</span></span></span><br><span class="line"><span class="function"><span class="params">            SocketChannel socketChannel = (SocketChannel) selectionKey.channel();</span></span></span><br><span class="line"><span class="function"><span class="params">            int count = socketChannel.read(buffer);</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">if</span> (count &lt; <span class="number">0</span>) &#123;</span></span></span><br><span class="line"><span class="function"><span class="params">                socketChannel.close();</span></span></span><br><span class="line"><span class="function"><span class="params">                selectionKey.cancel();</span></span></span><br><span class="line"><span class="function"><span class="params">                LOGGER.info(<span class="string">"&#123;&#125;\t Read ended"</span>, socketChannel);</span></span></span><br><span class="line"><span class="function"><span class="params">                <span class="keyword">return</span> <span class="literal">null</span>;</span></span></span><br><span class="line"><span class="function"><span class="params">            &#125; <span class="keyword">else</span> <span class="keyword">if</span>(count == <span class="number">0</span>) &#123;</span></span></span><br><span class="line"><span class="function"><span class="params">                <span class="keyword">return</span> <span class="literal">null</span>;</span></span></span><br><span class="line"><span class="function"><span class="params">            &#125;</span></span></span><br><span class="line"><span class="function"><span class="params">            LOGGER.info(<span class="string">"&#123;&#125;\t Read message &#123;&#125;"</span>, socketChannel, <span class="keyword">new</span> String(buffer.array()));</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">return</span> <span class="literal">null</span>;</span></span></span><br><span class="line"><span class="function"><span class="params">        &#125;)</span>;</span></span><br><span class="line"><span class="function">    &#125;</span></span><br><span class="line"><span class="function">&#125;</span></span><br></pre></td></tr></table></figure>
<h2 id="多Reactor"><a href="#多Reactor" class="headerlink" title="多Reactor"></a>多Reactor</h2><p>主Reactor 接收所有的请求，多个子 Reactor 处理所有的读/写请求<br><img src="/blog/2018/09/28/java/nio/muilt_reactors.png" title="多Reactor模式"></p>
<figure class="highlight processing"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> *  多 Reactor</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> class Server &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger <span class="built_in">log</span> = LoggerFactory.getLogger(Server.class);</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="built_in">int</span> port = <span class="number">1234</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> main(<span class="keyword">String</span>[] args) <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="comment">// 定义一个 主 Reactor</span></span><br><span class="line">        Selector selector = Selector.<span class="built_in">open</span>();</span><br><span class="line">        ServerSocketChannel serverSocketChannel = ServerSocketChannel.<span class="built_in">open</span>();</span><br><span class="line">        serverSocketChannel.configureBlocking(<span class="keyword">false</span>);</span><br><span class="line">        serverSocketChannel.bind(<span class="keyword">new</span> InetSocketAddress(port));</span><br><span class="line">        <span class="comment">// 在主 Reactor 上注册 serverSocketChannel，监听该 channel 的 accept 事件</span></span><br><span class="line">        serverSocketChannel.register(selector, SelectionKey.OP_ACCEPT);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 获取系统的处理器数量</span></span><br><span class="line">        <span class="built_in">int</span> cores = Runtime.getRuntime().availableProcessors();</span><br><span class="line">        Processor[] p = <span class="keyword">new</span> Processor[cores];</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 实例化多个 Processor，一个 Processor 对应有一个 子 Reactor</span></span><br><span class="line">        <span class="keyword">for</span>(<span class="built_in">int</span> i=<span class="number">0</span>;i&lt;p.length;i++)&#123;</span><br><span class="line">            p[i] = <span class="keyword">new</span> Processor();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">int</span> index = <span class="number">0</span>;</span><br><span class="line">        <span class="comment">// 阻塞线程，直到有一个channel处于就绪状态</span></span><br><span class="line">        <span class="keyword">while</span>(selector.select()&gt;<span class="number">0</span>)&#123;</span><br><span class="line">            Set&lt;SelectionKey&gt; keySet  = selector.selectedKeys();</span><br><span class="line">            <span class="keyword">for</span>(SelectionKey <span class="built_in">key</span> : keySet)&#123;</span><br><span class="line">                <span class="comment">// Selector 不会删除掉 SelectionKey，需要手动删除</span></span><br><span class="line">                keySet.remove(<span class="built_in">key</span>);</span><br><span class="line">                <span class="keyword">if</span>(<span class="built_in">key</span>.isAcceptable())&#123;</span><br><span class="line">                    <span class="comment">// 获取待 accept 状态的 SocketChannel</span></span><br><span class="line">                    ServerSocketChannel acceptChannel = (ServerSocketChannel) <span class="built_in">key</span>.channel();</span><br><span class="line">                    SocketChannel socketChannel = acceptChannel.accept();</span><br><span class="line">                    socketChannel.configureBlocking(<span class="keyword">false</span>);</span><br><span class="line">                    <span class="built_in">log</span>.info(<span class="string">" &#123;&#125; register "</span>,socketChannel);</span><br><span class="line">                    Processor processor = p[index++%cores];</span><br><span class="line">                    <span class="comment">// 将该 socketChannel 注册到分配的子 Reactor 上</span></span><br><span class="line">                    processor.addChannel(socketChannel);</span><br><span class="line">                    <span class="comment">// 唤醒调用 select() 后阻塞的线程</span></span><br><span class="line">                    processor.wakeUp();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight processing"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> class Processor &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger <span class="built_in">log</span> = LoggerFactory.getLogger(Processor.class);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 定义一个线程池</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ExecutorService service = Executors.newFixedThreadPool(<span class="number">2</span>*<span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 一个 Processor 对应一个 Selector</span></span><br><span class="line">    <span class="keyword">private</span> Selector selector;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Processor() <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="keyword">this</span>.selector = SelectorProvider.provider().openSelector();</span><br><span class="line">        start();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 将 SocketChannel 注册到 该 Processor 的 Selector 上</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> addChannel(SocketChannel channel) <span class="keyword">throws</span> ClosedChannelException &#123;</span><br><span class="line">        channel.register(selector, SelectionKey.OP_READ);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> wakeUp()&#123;</span><br><span class="line">        <span class="keyword">this</span>.selector.wakeup();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 每个 Processor 对应一个线程</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> start()&#123;</span><br><span class="line">        service.submit(()-&gt;&#123;</span><br><span class="line">            <span class="keyword">while</span>(<span class="keyword">true</span>)&#123;</span><br><span class="line">                <span class="keyword">if</span>(selector.select(<span class="number">5000</span>)&lt;=<span class="number">0</span>)&#123;</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                Set&lt;SelectionKey&gt; keys = selector.selectedKeys();</span><br><span class="line">                Iterator&lt;SelectionKey&gt; iterator = keys.iterator();</span><br><span class="line">                <span class="keyword">while</span>(iterator.hasNext())&#123;</span><br><span class="line">                    SelectionKey <span class="built_in">key</span> = iterator.next();</span><br><span class="line">                    <span class="comment">// Selector 不会删除掉 SelectionKey，需要手动删除</span></span><br><span class="line">                    iterator.remove();</span><br><span class="line">                    <span class="keyword">if</span>(<span class="built_in">key</span>.isReadable())&#123;</span><br><span class="line">                        ByteBuffer buffer = ByteBuffer.allocate(<span class="number">1024</span>);</span><br><span class="line">                        SocketChannel socketChannel = (SocketChannel) <span class="built_in">key</span>.channel();</span><br><span class="line">                        <span class="built_in">int</span> count = socketChannel.read(buffer);</span><br><span class="line">                        <span class="comment">// 如果客户端被关闭</span></span><br><span class="line">                        <span class="keyword">if</span>(count&lt;<span class="number">0</span>)&#123;</span><br><span class="line">                            socketChannel.close();</span><br><span class="line">                            <span class="built_in">key</span>.cancel();</span><br><span class="line">                            <span class="built_in">log</span>.info(<span class="string">"&#123;&#125;\t Read end"</span>,socketChannel);</span><br><span class="line">                            <span class="keyword">continue</span>;</span><br><span class="line">                        &#125;<span class="keyword">else</span> <span class="keyword">if</span>(count==<span class="number">0</span>)&#123;</span><br><span class="line">                            <span class="built_in">log</span>.info(<span class="string">" &#123;&#125;\t  Message size is 0"</span>,socketChannel);</span><br><span class="line">                        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                            <span class="built_in">log</span>.info(<span class="string">"&#123;&#125;\t Mesage is &#123;&#125;"</span>,socketChannel,<span class="keyword">new</span> <span class="keyword">String</span>(buffer.array()));</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h1><p><a href="http://tutorials.jenkov.com/java-nio/index.html" target="_blank" rel="noopener">Java Nio Tutorial</a><br><a href="https://tech.meituan.com/nio.html" target="_blank" rel="noopener">Java NIO浅析-美团</a><br><a href="http://www.jasongj.com/java/nio_reactor/" target="_blank" rel="noopener">Java I/O模型从BIO到NIO和Reactor模式</a><br><a href="http://codepub.cn/2016/02/01/Java-NIO-development-Precautions/" target="_blank" rel="noopener">Java NIO开发注意点</a><br><a href="http://jm.taobao.org/2010/10/22/380/" target="_blank" rel="noopener">Selector.wakeup实现注记</a></p>

      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/blog/tags/java/" rel="tag"># java</a>
          
            <a href="/blog/tags/nio/" rel="tag"># nio</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/blog/2018/09/28/java/desinmodel/" rel="next" title="设计模式">
                <i class="fa fa-chevron-left"></i> 设计模式
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/blog/2018/10/28/kafka/producer_init/" rel="prev" title="kafkaProducer之配置管理和初始化">
                kafkaProducer之配置管理和初始化 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>


  </div>


          </div>
          

  
    <div class="comments" id="comments">
      
        <div id="gitment-container"></div>
      
    </div>

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/blog/upload/head.jpg"
                alt="RainPoetry" />
            
              <p class="site-author-name" itemprop="name">RainPoetry</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/blog/archives/">
                
                    <span class="site-state-item-count">6</span>
                    <span class="site-state-item-name">日志</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  <a href="/blog/categories/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">5</span>
                    <span class="site-state-item-name">分类</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  <a href="/blog/tags/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">12</span>
                    <span class="site-state-item-name">标签</span>
                  </a>
                </div>
              
            </nav>
          

          

          
            <div class="links-of-author motion-element">
              
                <span class="links-of-author-item">
                  <a href="https://github.com/RainPoetry" target="_blank" title="GitHub"><i class="fa fa-fw fa-github"></i>GitHub</a>
                  
                </span>
              
                <span class="links-of-author-item">
                  <a href="1060465696@qq.com" target="_blank" title="E-Mail"><i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                  
                </span>
              
                <span class="links-of-author-item">
                  <a href="https://plus.google.com/" target="_blank" title="Google"><i class="fa fa-fw fa-google"></i>Google</a>
                  
                </span>
              
            </div>
          

          
          

          
          

          
            
          
          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#前言"><span class="nav-number">1.</span> <span class="nav-text">前言</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#nio-核心组件"><span class="nav-number">2.</span> <span class="nav-text">nio 核心组件</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Channel"><span class="nav-number">3.</span> <span class="nav-text">Channel</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#channel-类别"><span class="nav-number">3.1.</span> <span class="nav-text">channel 类别</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#FileChannel"><span class="nav-number">3.2.</span> <span class="nav-text">FileChannel</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Buffer"><span class="nav-number">4.</span> <span class="nav-text">Buffer</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#buffer-类别"><span class="nav-number">4.1.</span> <span class="nav-text">buffer 类别</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#buffer-重要属性"><span class="nav-number">4.2.</span> <span class="nav-text">buffer 重要属性</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#buffer-的使用方式"><span class="nav-number">4.3.</span> <span class="nav-text">buffer 的使用方式</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#创建-buffer"><span class="nav-number">4.3.1.</span> <span class="nav-text">创建 buffer</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#写入数据到-buffer"><span class="nav-number">4.3.2.</span> <span class="nav-text">写入数据到 buffer</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#获取-buffer-中的数据"><span class="nav-number">4.3.3.</span> <span class="nav-text">获取 buffer 中的数据</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#buffer-重要方法"><span class="nav-number">4.4.</span> <span class="nav-text">buffer 重要方法</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Selector"><span class="nav-number">5.</span> <span class="nav-text">Selector</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#selector-使用"><span class="nav-number">5.1.</span> <span class="nav-text">selector 使用</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#创建-selector"><span class="nav-number">5.1.1.</span> <span class="nav-text">创建 selector</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#向-selector-注册-channel"><span class="nav-number">5.1.2.</span> <span class="nav-text">向 selector 注册 channel</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#监听事件"><span class="nav-number">5.1.3.</span> <span class="nav-text">监听事件</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Selector-重要函数"><span class="nav-number">5.2.</span> <span class="nav-text">Selector 重要函数</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Reactor-模式"><span class="nav-number">6.</span> <span class="nav-text">Reactor 模式</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#单线程处理所有请求"><span class="nav-number">6.1.</span> <span class="nav-text">单线程处理所有请求</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#多线程处理"><span class="nav-number">6.2.</span> <span class="nav-text">多线程处理</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#多Reactor"><span class="nav-number">6.3.</span> <span class="nav-text">多Reactor</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#参考链接"><span class="nav-number">7.</span> <span class="nav-text">参考链接</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <center>
<div class="copyright">&copy; <span itemprop="copyrightYear">2018</span>
  <span class="with-love" id="animate">
    <i class="fa fa-"></i>
  </span>
  <span class="with-love" id="heart">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">RainPoetry</span>

  

  
</div>










</center>
        








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    
	
    

    
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>












  















  
  
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
  

  
  
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/velocity/1.2.1/velocity.min.js"></script>
  

  
  
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/velocity/1.2.1/velocity.ui.min.js"></script>
  

  
  
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.2.5/jquery.fancybox.min.js"></script>
  


  


  <script type="text/javascript" src="/blog/js/src/utils.js?v=6.4.0"></script>

  <script type="text/javascript" src="/blog/js/src/motion.js?v=6.4.0"></script>



  
  

  
  <script type="text/javascript" src="/blog/js/src/scrollspy.js?v=6.4.0"></script>
<script type="text/javascript" src="/blog/js/src/post-details.js?v=6.4.0"></script>



  


  <script type="text/javascript" src="/blog/js/src/bootstrap.js?v=6.4.0"></script>



  



  






<!-- LOCAL: You can save these files to your site and update links -->
    
        
        <link rel="stylesheet" href="https://aimingoo.github.io/gitmint/style/default.css">
        <script src="https://aimingoo.github.io/gitmint/dist/gitmint.browser.js"></script>
    
<!-- END LOCAL -->

    

    
      <script type="text/javascript">
      function renderGitment(){
        var gitment = new Gitmint({
            id: window.location.pathname,
            owner: 'RainPoetry',
            repo: 'gitment-comments',
            
            lang: "zh-Hans" || navigator.language || navigator.systemLanguage || navigator.userLanguage,
            
            oauth: {
            
            
                client_secret: '0a92e76eca560bd8ae8c29a56b56fe9f5de36087',
            
                client_id: '944f011a42bbcd3ef468'
            }});
        gitment.render('gitment-container');
      }

      
      renderGitment();
      
      </script>
    






  





  

  
  <script>
    
    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();

      Counter('get', '/classes/Counter', { where: JSON.stringify({ url }) })
        .done(function ({ results }) {
          if (results.length > 0) {
            var counter = results[0];
            
            Counter('put', `/classes/Counter/${counter.objectId}`, JSON.stringify({ time: { "__op":"Increment", "amount":1 } }))
            
            .done(function () {
                  var $element = $(document.getElementById(url));
                  $element.find('.leancloud-visitors-count').text(counter.time + 1);
            })
            
            .fail(function ({ responseJSON }) {
                console.log('Failed to save Visitor num, with error message: ' + responseJSON.error);
            })
          } else {
            
              Counter('post', '/classes/Counter', JSON.stringify({ title: title, url: url, time: 1}))
                .done(function () {
                  var $element = $(document.getElementById(url));
                  $element.find('.leancloud-visitors-count').text(1);
                })
                .fail(function () {
                  console.log('Failed to create');
                });
            
          }
        })
      .fail(function ({ responseJSON }) {
        console.log('LeanCloud Counter Error:' + responseJSON.code + " " + responseJSON.error);
      });
    }
    

    $(function() {
      $.get('https://app-router.leancloud.cn/2/route?appId=' + "qbL9f9djMfTnp04Y8uM6Gop9-gzGzoHsz")
        .done(function ({ api_server }) {
          var Counter = function (method, url, data) {
            return $.ajax({
              method: method,
              url: `https://${api_server}/1.1${url}`,
              headers: {
                'X-LC-Id': "qbL9f9djMfTnp04Y8uM6Gop9-gzGzoHsz",
                'X-LC-Key': "g83WulAHEtJidIfjwR82Brb5",
                'Content-Type': 'application/json',
              },
              data: data,
            });
          };
          
          addCount(Counter);
          
        })
    });
  </script>



  

  

  
  

  
  

  


  
  

  

  

  

  

  

  <script type="text/javascript" src="/blog/js/src/love.js"></script>
<script async>window.onload=function(){var a=document.createElement('script'),b=document.getElementsByTagName('script')[0];a.type='text/javascript',a.async=!0,a.src='/sw-register.js?v='+Date.now(),b.parentNode.insertBefore(a,b)};</script></body></html>